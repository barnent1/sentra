name: Sentra AI Agent Worker

# Triggers when issue is labeled with "ai-feature"
on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-agent-work:
    # Only run if issue has "ai-feature" label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-feature')) ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'ai-feature'))

    runs-on: ubuntu-latest
    timeout-minutes: 45  # Higher limit for complex Sentra tasks

    # Phase 1: Docker Containerization for Security
    # See: ADR_0001_CONTAINER_SECURITY.md
    container:
      image: ghcr.io/${{ github.repository_owner }}/sentra-agent:latest
      options: >-
        --cap-drop=ALL
        --security-opt=no-new-privileges
        --read-only
        --tmpfs /tmp:exec,mode=1777
        --tmpfs /home/claude-agent:exec,mode=0755
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for context

      # Container already has Python, Node.js, and dependencies installed
      # See: .claude/Dockerfile for complete environment setup

      - name: Verify container environment
        run: |
          echo "üê≥ Running in secure Docker container"
          echo "Python: $(python3.11 --version)"
          echo "Node: $(node --version)"
          echo "User: $(whoami)"
          echo "UID: $(id -u)"

      - name: Create feature branch
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch already exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch"
            git checkout -b "$BRANCH_NAME"
          fi

          # Configure git
          git config user.name "Sentra AI Agent"
          git config user.email "agent@sentra.dev"

      - name: Load Sentra project context
        run: |
          echo "üìö Loading Sentra project context..."
          if [ -f ".sentra/memory/project-overview.md" ]; then
            echo "‚úÖ Project overview loaded"
          fi
          if [ -f ".sentra/config.yml" ]; then
            echo "‚úÖ Project configuration loaded"
          fi

      - name: Run AI Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_MAX_EXECUTION_TIME: '45'
          CLAUDE_MAX_API_CALLS_PER_ISSUE: '150'
          CLAUDE_MAX_FILE_CHANGES: '75'
          CLAUDE_REQUIRE_TESTS: 'false'  # No tests yet in early phase
          CLAUDE_GITHUB_COMMENTS: 'true'
          CLAUDE_LOG_API_CALLS: 'true'
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}

          # Scripts are checked into the repository at .claude/scripts/
          chmod +x .claude/scripts/ai-agent-worker.py .claude/scripts/notify.sh

          # Run the AI agent
          python3 .claude/scripts/ai-agent-worker.py "$ISSUE_NUMBER" . | tee agent-output.json

      - name: Upload agent logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.event.issue.number }}
          path: |
            ~/.claude/telemetry/agents.log
            agent-output.json
          retention-days: 30

      - name: Report success
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BODY="‚úÖ AI agent completed this task successfully!\n\nA pull request should be created shortly. Please review the changes and merge when ready.\n\nView [workflow logs]($WORKFLOW_URL) for details."
          gh issue comment "$ISSUE_NUMBER" --body "$BODY"

      - name: Report failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BODY="‚ùå AI agent encountered an issue while working on this task.\n\nCheck the [workflow logs]($WORKFLOW_URL) for details.\n\nThis issue has been labeled 'needs-help' and requires human attention."
          gh issue comment "$ISSUE_NUMBER" --body "$BODY"
          gh issue edit "$ISSUE_NUMBER" --add-label "needs-help"
