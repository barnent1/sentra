name: Sentra AI Agent Worker

# Triggers when issue is labeled with "ai-feature"
on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-agent-work:
    # Only run if issue has "ai-feature" label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-feature')) ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'ai-feature'))

    runs-on: ubuntu-latest
    timeout-minutes: 45  # Higher limit for complex Sentra tasks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for context

      - name: Setup Rust (for Tauri builds)
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install anthropic requests

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install project dependencies
        run: |
          npm ci
        continue-on-error: true

      - name: Create feature branch
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch already exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch"
            git checkout -b "$BRANCH_NAME"
          fi

          # Configure git
          git config user.name "Sentra AI Agent"
          git config user.email "agent@sentra.dev"

      - name: Load Sentra project context
        run: |
          echo "üìö Loading Sentra project context..."
          if [ -f ".sentra/memory/project-overview.md" ]; then
            echo "‚úÖ Project overview loaded"
          fi
          if [ -f ".sentra/config.yml" ]; then
            echo "‚úÖ Project configuration loaded"
          fi

      - name: Run AI Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLAUDE_MAX_EXECUTION_TIME: '45'
          CLAUDE_MAX_API_CALLS_PER_ISSUE: '150'
          CLAUDE_MAX_FILE_CHANGES: '75'
          CLAUDE_REQUIRE_TESTS: 'false'  # No tests yet in early phase
          CLAUDE_GITHUB_COMMENTS: 'true'
          CLAUDE_LOG_API_CALLS: 'true'
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}

          # Scripts are checked into the repository at .claude/scripts/
          chmod +x .claude/scripts/ai-agent-worker.py .claude/scripts/notify.sh

          # Run the AI agent
          python3 .claude/scripts/ai-agent-worker.py "$ISSUE_NUMBER" . | tee agent-output.json

      - name: Upload agent logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.event.issue.number }}
          path: |
            ~/.claude/telemetry/agents.log
            agent-output.json
          retention-days: 30

      - name: Report success
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BODY="‚úÖ AI agent completed this task successfully!\n\nA pull request should be created shortly. Please review the changes and merge when ready.\n\nView [workflow logs]($WORKFLOW_URL) for details."
          gh issue comment "$ISSUE_NUMBER" --body "$BODY"

      - name: Report failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BODY="‚ùå AI agent encountered an issue while working on this task.\n\nCheck the [workflow logs]($WORKFLOW_URL) for details.\n\nThis issue has been labeled 'needs-help' and requires human attention."
          gh issue comment "$ISSUE_NUMBER" --body "$BODY"
          gh issue edit "$ISSUE_NUMBER" --add-label "needs-help"
