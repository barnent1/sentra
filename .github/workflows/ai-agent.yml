name: Quetrex AI Agent Worker

# Triggers when issue is labeled with "ai-feature"
on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: number

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ai-agent-work:
    # Only run if issue has "ai-feature" label
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-feature')) ||
      (github.event_name == 'issue_comment' && contains(github.event.issue.labels.*.name, 'ai-feature'))

    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Phase 1: Docker Containerization for Security
    # Risk reduction: 60-70%
    #
    # Security measures:
    # - Read-only root filesystem (--read-only)
    # - No Linux capabilities (--cap-drop=ALL)
    # - No privilege escalation (--security-opt=no-new-privileges)
    # - Resource limits (2GB RAM, 2 CPU cores, 100 processes)
    #
    # Tmpfs mounts (ephemeral, cleared after run):
    # - /tmp: Standard temporary files
    # - ~/.cache: Python pip cache, npm cache
    # - ~/workspace: Working directory for git operations
    # - ~/.claude/telemetry: Claude Code logs
    container:
      image: ghcr.io/${{ github.repository_owner }}/quetrex-agent:latest
      options: >-
        --cap-drop=ALL
        --security-opt=no-new-privileges
        --read-only
        --tmpfs /tmp:exec,mode=1777
        --tmpfs /home/claude-agent/.cache:exec,mode=0755
        --tmpfs /home/claude-agent/workspace:exec,mode=0755
        --tmpfs /home/claude-agent/.claude/telemetry:exec,mode=0755
        --memory=2g
        --memory-swap=2g
        --cpus=2
        --pids-limit=100
        --oom-kill-disable=false
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install npm dependencies
        run: npm ci
        working-directory: ${{ github.workspace }}

      - name: Verify container environment
        run: |
          echo "üê≥ Running in secure Docker container (Phase 1 Security)"
          echo ""
          echo "=== Runtime Versions ==="
          echo "Python: $(python3.11 --version)"
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"
          echo ""
          echo "=== Claude Code CLI ==="
          if command -v claude &> /dev/null; then
            echo "‚úÖ Claude Code CLI: $(claude --version)"
          else
            echo "‚ùå Claude Code CLI NOT FOUND"
            exit 1
          fi

      - name: Create feature branch
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          BRANCH_NAME="feature/issue-${ISSUE_NUMBER}"

          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch exists, checking out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch"
            git checkout -b "$BRANCH_NAME"
          fi

          git config user.name "Quetrex AI Agent"
          git config user.email "agent@quetrex.dev"

      - name: Run AI Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DISABLE_AUTOUPDATER: 'true'
          DISABLE_TELEMETRY: 'true'
          CLAUDE_MAX_EXECUTION_TIME: '45'
          CLAUDE_MAX_API_CALLS_PER_ISSUE: '150'
          CLAUDE_MAX_FILE_CHANGES: '75'
          CLAUDE_REQUIRE_TESTS: 'false'
          CLAUDE_GITHUB_COMMENTS: 'true'
          CLAUDE_LOG_API_CALLS: 'true'
          CLAUDE_RATE_LIMIT_TPM: '25000'
          CLAUDE_RATE_LIMIT_RETRIES: '3'
          CLAUDE_RATE_LIMIT_THRESHOLD: '0.8'
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}

          echo "ü§ñ Starting AI Agent for issue #$ISSUE_NUMBER"
          echo "üîí Phase 1 Security: Docker container isolation active"

          chmod +x .claude/scripts/ai-agent-worker.py .claude/scripts/notify.sh

          python3.11 .claude/scripts/ai-agent-worker.py "$ISSUE_NUMBER" . | tee agent-output.json || exit 1

      - name: Upload agent logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.event.issue.number }}
          path: |
            ~/.claude/telemetry/agents.log
            agent-output.json
          retention-days: 30

      - name: Report success
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ -f agent-output.json ]; then
            PR_URL=$(grep -o '"pr_url": "[^"]*"' agent-output.json | cut -d'"' -f4 | tail -1)
            if [ -z "$PR_URL" ] || [ "$PR_URL" = "null" ]; then
              BODY="‚úÖ AI agent completed!\n\n‚ö†Ô∏è PR may need manual creation. See [workflow logs]($WORKFLOW_URL)."
              gh issue comment "$ISSUE_NUMBER" --body "$BODY"
            fi
          fi

      - name: Report failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue_number || github.event.issue.number }}
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          BODY="‚ùå AI agent failed.\n\nSee [workflow logs]($WORKFLOW_URL)."
          gh issue comment "$ISSUE_NUMBER" --body "$BODY"
          gh issue edit "$ISSUE_NUMBER" --add-label "needs-help"
