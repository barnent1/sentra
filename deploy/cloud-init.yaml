#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - nginx
  - certbot
  - python3-certbot-nginx

users:
  - name: quetrex
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

write_files:
  - path: /opt/quetrex/install.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Install Node.js 20
      curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
      apt-get install -y nodejs

      # Install PM2
      npm install -g pm2

      # Clone Quetrex
      cd /opt
      git clone https://github.com/barnent1/quetrex.git quetrex-app || true
      cd quetrex-app

      # Install dependencies
      npm install

      # Build
      npm run build

      echo "Quetrex installed successfully"

  - path: /etc/nginx/sites-available/quetrex
    content: |
      server {
          listen 80;
          server_name _;

          location / {
              proxy_pass http://127.0.0.1:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
              proxy_read_timeout 86400;
          }
      }

  - path: /opt/quetrex/start.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      cd /opt/quetrex-app
      pm2 start npm --name "quetrex" -- start
      pm2 save
      pm2 startup systemd -u root --hp /root

runcmd:
  - /opt/quetrex/install.sh
  - ln -sf /etc/nginx/sites-available/quetrex /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - systemctl restart nginx
  - echo "Server ready for configuration"
